WITH combined_water AS (
  SELECT
    LSOA_CODE,
    Year AS year,
    TOTAL_CONSUMPTION AS water_consumption_litres,
    DATA_SOURCE AS company_name
  FROM water_data
),

with_company_id AS (
  SELECT
    cw.*,
    dwc.company_id
  FROM combined_water cw
  LEFT JOIN dim_water_company dwc
    ON cw.company_name = dwc.company_name
),

with_location AS (
  SELECT
    wci.*,
    dl.region_name
  FROM with_company_id wci
  LEFT JOIN dim_location dl
    ON wci.LSOA_CODE = dl.lsoa_code
),

with_homeworking AS (
  SELECT
    wl.*,
    dh.homeworking_percentage
  FROM with_location wl
  LEFT JOIN dim_homeworking dh
    ON wl.region_name = dh.region_name
    AND wl.year = dh.year
)

SELECT
  LSOA_CODE AS lsoa_code,
  year,
  company_id,
  region_name,
  homeworking_percentage,
  water_consumption_litres
FROM with_homeworking
ORDER BY lsoa_code, year;